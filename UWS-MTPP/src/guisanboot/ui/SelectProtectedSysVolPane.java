/*
 * SelectProtectedSysVolPane.java
 *
 * Created on 2006/12/29,�AM�9:52
 */

package guisanboot.ui;

import guisanboot.cluster.entity.AccessPath;
import guisanboot.cluster.entity.ClusterVolume;
import guisanboot.cluster.entity.SubCluster;
import guisanboot.cmdp.entity.VolumeWrapper2;
import guisanboot.cmdp.ui.multiRenderTable.JTableX2;
import guisanboot.cmdp.ui.multiRenderTable.MyDefaultTableModelForTabX2;
import java.awt.*;
import javax.swing.*;
import javax.swing.table.*;
import java.util.*;
import guisanboot.res.*;
import guisanboot.data.*;
import guisanboot.datadup.data.BackupClient;
import guisanboot.ui.multiRenderTable.*;
import mylib.tool.Check;

/**
 *
 * @author  Administrator
 */
public class SelectProtectedSysVolPane extends javax.swing.JPanel implements SelectProtectedFS{
    
    /** Creates new form SelectProtectedSysVolPane */
    public SelectProtectedSysVolPane() {
        initComponents();
    }

    public SelectProtectedSysVolPane( SanBootView view ){
        this( view,ResourceCenter.CMD_TYPE_MTPP );
    }

    public SelectProtectedSysVolPane( SanBootView view,int mode ) {
        this();
        myInit( view,mode );
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;

        jPanel1 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jPanel3 = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTextArea1 = new javax.swing.JTextArea();
        jPanel5 = new javax.swing.JPanel();
        jScrollPane2 = new javax.swing.JScrollPane();
        jPanel7 = new javax.swing.JPanel();
        jRadioButton1 = new javax.swing.JRadioButton();
        jRadioButton2 = new javax.swing.JRadioButton();
        jRadioButton3 = new javax.swing.JRadioButton();
        jLabel1 = new javax.swing.JLabel();

        setLayout(new java.awt.BorderLayout());

        jPanel1.setPreferredSize(new java.awt.Dimension(20, 10));
        add(jPanel1, java.awt.BorderLayout.WEST);

        jPanel2.setPreferredSize(new java.awt.Dimension(20, 10));
        add(jPanel2, java.awt.BorderLayout.EAST);

        jPanel3.setLayout(new java.awt.BorderLayout());

        jPanel4.setLayout(new java.awt.BorderLayout());

        jPanel4.setPreferredSize(new java.awt.Dimension(10, 60));
        jScrollPane1.setBorder(new javax.swing.border.EmptyBorder(new java.awt.Insets(1, 1, 1, 1)));
        jTextArea1.setLineWrap(true);
        jTextArea1.setDisabledTextColor(java.awt.Color.black);
        jTextArea1.setEnabled(false);
        jTextArea1.setOpaque(false);
        jScrollPane1.setViewportView(jTextArea1);

        jPanel4.add(jScrollPane1, java.awt.BorderLayout.CENTER);

        jPanel3.add(jPanel4, java.awt.BorderLayout.NORTH);

        jPanel5.setLayout(new java.awt.BorderLayout());

        jPanel5.add(jScrollPane2, java.awt.BorderLayout.CENTER);

        jPanel7.setLayout(new java.awt.GridBagLayout());

        jPanel7.setBorder(new javax.swing.border.EmptyBorder(new java.awt.Insets(2, 1, 1, 1)));
        jRadioButton1.setText("Copy OS & modify register");
        jRadioButton1.setBorder(new javax.swing.border.EmptyBorder(new java.awt.Insets(1, 1, 1, 1)));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        jPanel7.add(jRadioButton1, gridBagConstraints);

        jRadioButton2.setText("Only modify register");
        jRadioButton2.setBorder(new javax.swing.border.EmptyBorder(new java.awt.Insets(1, 1, 1, 1)));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.insets = new java.awt.Insets(0, 30, 0, 0);
        jPanel7.add(jRadioButton2, gridBagConstraints);

        jRadioButton3.setText("Do nothing");
        jRadioButton3.setBorder(new javax.swing.border.EmptyBorder(new java.awt.Insets(1, 1, 1, 1)));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 2;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.insets = new java.awt.Insets(0, 30, 0, 0);
        jPanel7.add(jRadioButton3, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 3;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.insets = new java.awt.Insets(0, 80, 0, 0);
        jPanel7.add(jLabel1, gridBagConstraints);

        jPanel5.add(jPanel7, java.awt.BorderLayout.SOUTH);

        jPanel3.add(jPanel5, java.awt.BorderLayout.CENTER);

        add(jPanel3, java.awt.BorderLayout.CENTER);

    }
    // </editor-fold>//GEN-END:initComponents
    
    
    ////GEN-BEGIN:variables
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JRadioButton jRadioButton1;
    private javax.swing.JRadioButton jRadioButton2;
    private javax.swing.JRadioButton jRadioButton3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTextArea jTextArea1;
    ////GEN-END:variables
    
    Vector curVolUsage = null;
    JTable table;
    SanBootView view;
    Object[] header;
    Object[] label;
    WizardDialogSample wizardDiag;
    float vgSize;
    ButtonGroup grp = new ButtonGroup();
    int mode;
    private boolean hasEnoughSpace = true;
    private boolean isCluster = false;
    private boolean isUUIDCluster = false;
    
    ArrayList<String> vipList = new ArrayList<String>();
    ArrayList<String> pubIpList = new ArrayList<String>();

    private void myInit( SanBootView _view,int mode ){
        view = _view;
        this.mode = mode;

        if( mode == ResourceCenter.CMD_TYPE_MTPP ){
            jTextArea1.setText(
                SanBootView.res.getString("InitBootHostWizardDialog.tip2")
            );
        }else{
            jTextArea1.setText(
                SanBootView.res.getString("InitBootHostWizardDialog.p-tip2")
            );
        }
        jRadioButton1.setText( SanBootView.res.getString("SelectProtectedSysVolPane.radioBtn.copyos") );
        jRadioButton2.setText( SanBootView.res.getString("SelectProtectedSysVolPane.radioBtn.modRegister") );
        jRadioButton3.setText( SanBootView.res.getString("SelectProtectedSysVolPane.radioBtn.doNothing") );
        
        grp.add( jRadioButton1 );
        grp.add( jRadioButton2 );
        grp.add( jRadioButton3 );
        jPanel7.remove( jRadioButton1 );
        jPanel7.remove( jRadioButton2 );
        jPanel7.remove( jRadioButton3 );
        jPanel7.remove( jLabel1 );
        jRadioButton3.setSelected( true );
    }
    
    public void modTipText( float _vgSize ){
        jTextArea1.append( SanBootView.res.getString("SelectProtectedSysVolPane.label.maxFreeSize") +
                "  "+
                _vgSize + 
                "GB  " +
                SanBootView.res.getString("SelectProtectedSysVolPane.label.maxFreeSize1"));
        vgSize = _vgSize;
    }

    public void setupVipList( String[] vipList ){
        this.vipList.clear();
        for( int i=0; i<vipList.length; i++ ){
            this.vipList.add( vipList[i] );
        }
    }
    
    public void setupPubIPList( String[] pubIPList ){
        this.pubIpList.clear();
        for( int i=0; i<pubIPList.length; i++ ){
            this.pubIpList.add( pubIPList[i] );
        }
    }

    public void setCurVolUsage( Vector list ){
        this.curVolUsage = list;
    }

    public void setHasEnoughSpaceFlag( boolean val ){
        this.hasEnoughSpace = val;
    }

    public void setIsClusterFlag( boolean val ){
        this.isCluster = val;
    }

    public void setIsUUIDClusterFlag( boolean val){
        this.isUUIDCluster = val;
    }
    
    int cluster_type = ResourceCenter.TYPE_CLUS_NOT_RAC_INT;
    public void setClusterType( int type ){
        this.cluster_type = type;
    }
    public void setupTable( Vector list ){
        if( mode == ResourceCenter.CMD_TYPE_MTPP ){
            this.setupTableForMTPP( list );
        }else{
            if( this.isCluster ){
                this.setupTableForUnitedProtectAndCluster( list );
            }else{
                this.setupTableForUnitedProtect( list );
            }
        }
    }

    public void setupTableForCMDP( Vector list ){
        ArrayList blkList  = BasicVDisk.getBlkSizeList();
        ArrayList poolList = view.initor.mdb.getPoolWrapList( true );

        int num = list.size();
        int colNum = 7;
        Object[][] data = new Object[num][colNum];

        header = new Object[colNum];
        label = new Object[num];

        header[0] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.protected");
        header[1] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.vol");
        header[2] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.state");
        header[3] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.blksize");
        header[4] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.pool");
        header[5] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.maxSnap");
        header[6] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.desc");

        for( int i=0; i<num; i++ ){
            BindOfPartandVol binder = (BindOfPartandVol)list.elementAt(i);
            data[i][0] = new Boolean( binder.isProtected );
            data[i][1] = binder.part;
            if( binder.isRealVol ){
                data[i][2] = (VolumeWrapper2)binder.vol;
            }else{
                data[i][2] = SanBootView.res.getString("common.nprotected");
            }

            if( binder.isRealVol ){
                data[i][3] = BasicVDisk.getBlkSizeStr( binder.vol.getSnap_block_size() );
            }else{
                data[i][3] = BasicVDisk.BLK_SIZE_128K;
            }

            if( binder.isRealVol ){
                PoolWrapper wrap = view.initor.mdb.getPoolWrapper( binder.vol.getSnap_pool_id() );
                if( wrap != null ){
                    data[i][4] = wrap;
                }else{
                    data[i][4] ="";
                }
            }else{
                if( poolList.size() >0 ){
                    data[i][4] = poolList.get(0);
                }else{
                    data[i][4]="";
                }
            }

            data[i][5] = binder.getMaxSnap();
            data[i][6] = binder.desc;

            label[i]= binder.part.getDiskLabel();
        }

        MyDefaultTableModelForTabX2 model = new MyDefaultTableModelForTabX2( data,header,label );

        table = new JTableX2( model,view,wizardDiag );
        table.setRowHeight( 20 );
        table.setAutoResizeMode( JTable.AUTO_RESIZE_OFF );

        RowEditorModel rm = new RowEditorModel();
        ((JTableX2)table).setRowEditorModel(rm);

        CheckBoxEditor cb = new CheckBoxEditor();
        rm.addEditorForRow( 0, cb );

        MyComboBoxEditor mcb = new MyComboBoxEditor( blkList );
        rm.addEditorForRow( 3, mcb );

        mcb = new MyComboBoxEditor( poolList );
        rm.addEditorForRow( 4, mcb );

        TableColumnModel tableColumnModel = table.getColumnModel();
        colNum = tableColumnModel.getColumnCount();
        tableColumnModel.getColumn(0).setWidth( 45 );
        tableColumnModel.getColumn(1).setWidth( 60 );
        tableColumnModel.getColumn(2).setWidth( 70 );
        tableColumnModel.getColumn(3).setWidth( 80 );
        tableColumnModel.getColumn(4).setWidth( 175 );
        tableColumnModel.getColumn(5).setWidth( 75 );
        tableColumnModel.getColumn(6).setWidth( 150 );
        for( int j=0;j<colNum;j++ )
            table.sizeColumnsToFit( j );

        table.getTableHeader().setBorder( BorderFactory.createRaisedBevelBorder() );
        table.getTableHeader().setReorderingAllowed(false);

        jScrollPane2.getViewport().add( table,null );
        jScrollPane2.getViewport().setBackground( Color.white );
    }
    
    public void setupTableForUnitedProtectAndCluster( Vector list ){
        String lp = SanBootView.res.getString("SelectProtectedSysVolPane.combox.lp");
        String pp = SanBootView.res.getString("SelectProtectedSysVolPane.combox.pp");
        ArrayList ptypeList = new ArrayList();
        ptypeList.add( lp );
        ptypeList.add( pp );

        ArrayList blkList  = BasicVDisk.getBlkSizeList();
        ArrayList poolList = view.initor.mdb.getNormalPoolWrapList(true);

        int num = list.size();
        int colNum = 10;
        Object[][] data = new Object[num][colNum];

        header = new Object[colNum];
        label = new Object[num];

        header[0] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.protected");
        header[1] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.vol");
        header[2] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.state");
        header[3] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.ptype");
        header[4] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.access");
        header[5] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.blksize");
        header[6] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.pool");
        header[7] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.maxSnap");
        header[8] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.formatted");
        header[9] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.desc");
        
        for( int i=0; i<num; i++ ){
            BindOfPartandVol binder = (BindOfPartandVol)list.elementAt(i);
            data[i][0] = new Boolean( binder.isProtected );
            data[i][1] = binder.part;
            if( binder.isRealVol ){
                data[i][2] = (VolumeWrapper2)binder.vol;
            }else{
                data[i][2] = SanBootView.res.getString("common.nprotected");
            }

            data[i][3] = ( binder.ptype == BootHost.PROTECT_TYPE_CMDP )?pp:lp;
            if( binder.isRealVol ){
                VolumeMap volMap = view.initor.mdb.getVolMapOnRootID( ((VolumeWrapper2)binder.vol).getSnap_root_id() );
                AccessPath ap = new AccessPath();
                ap.isLocal = !volMap.isClusterSharedDisk();
                if( ap.isLocal ){
                    BootHost aHost = view.initor.mdb.getHostFromVectorOnID( volMap.getVolClntID() );
                    ap.ip = aHost.getIP();
                }else{
                    if( this.cluster_type == ResourceCenter.TYPE_CLUS_NOT_RAC_INT ){
                        BootHost aHost2 = view.initor.mdb.getHostFromVectorOnID( volMap.getVolClntID() );
                        ap.ip = aHost2.getIP();
                    }else{
                        BootHost aHost1 = view.initor.mdb.getHostFromCacheOnUUID( binder.part.getHost_uuid() );
                        ap.ip = aHost1.getClnt_vip();
                    }
                }
                data[i][4] = ap;
            }else{
                data[i][4] =  new AccessPath( this.pubIpList.get(0),true );
            }

            if( binder.isRealVol ){
                data[i][5] = BasicVDisk.getBlkSizeStr( binder.vol.getSnap_block_size() );
            }else{
                data[i][5] = BasicVDisk.BLK_SIZE_128K;
            }

            if( binder.isRealVol ){
                PoolWrapper wrap = view.initor.mdb.getPoolWrapper( binder.vol.getSnap_pool_id() );
                if( wrap != null ){
                    data[i][6] = wrap;
                }else{
                    data[i][6] ="";
                }
            }else{
                if( poolList.size() >0 ){
                    data[i][6] = poolList.get(0);
                }else{
                    data[i][6]="";
                }
            }

            data[i][7] = binder.getMaxSnap();
            data[i][8] =  new Boolean( binder.isFormatted );
            data[i][9] = binder.desc;

            label[i]= binder.part.getDiskLabel();
        }

        MyDefaultTableModelForTabX2 model = new MyDefaultTableModelForTabX2( data,header,label );

        table = new JTableX2( model,view,wizardDiag );
        table.setRowHeight( 20 );
        table.setAutoResizeMode( JTable.AUTO_RESIZE_OFF );
        ((JTableX2)table).setIsCluster( isCluster );
        ((JTableX2)table).setVipList( this.vipList );
        ((JTableX2)table).setPubIPList( this.pubIpList );

        RowEditorModel rm = new RowEditorModel();
        ((JTableX2)table).setRowEditorModel(rm);

        CheckBoxEditor cb = new CheckBoxEditor();
        rm.addEditorForRow( 0, cb );

        MyComboBoxEditor mcb = new MyComboBoxEditor( ptypeList );
        rm.addEditorForRow( 3, mcb );
        
        RowEditorModel rmFor4Col = new RowEditorModel();
        ((JTableX2)table).set4ColRowEditorModel( rmFor4Col );
        for( int i=0; i<num; i++ ){
            PaneEditor2 pe = new PaneEditor2( (JTableX2)table,this.vipList,this.pubIpList );
            rmFor4Col.addEditorForRow( i, pe );
        }

        MyComboBoxEditor mcb1 = new MyComboBoxEditor( blkList );
        rm.addEditorForRow( 5, mcb1 );

        mcb = new MyComboBoxEditor( poolList );
        rm.addEditorForRow( 6, mcb );

        cb = new CheckBoxEditor();
        rm.addEditorForRow( 8, cb );

        TableColumnModel tableColumnModel = table.getColumnModel();
        colNum = tableColumnModel.getColumnCount();
        tableColumnModel.getColumn(0).setWidth( 45 );
        tableColumnModel.getColumn(1).setWidth( 60 );
        tableColumnModel.getColumn(2).setWidth( 70 );
        tableColumnModel.getColumn(3).setWidth( 70 );
        tableColumnModel.getColumn(4).setWidth( 220 );
        tableColumnModel.getColumn(5).setWidth( 80 );
        tableColumnModel.getColumn(6).setWidth( 175 );
        tableColumnModel.getColumn(7).setWidth( 75 );
        tableColumnModel.getColumn(8).setWidth( 60 );
        tableColumnModel.getColumn(9).setWidth( 150 );
        for( int j=0;j<colNum;j++ )
            table.sizeColumnsToFit( j );

        table.getTableHeader().setBorder( BorderFactory.createRaisedBevelBorder() );
        table.getTableHeader().setReorderingAllowed(false);

        jScrollPane2.getViewport().add( table,null );
        jScrollPane2.getViewport().setBackground( Color.white );
    }

 public void setupTableForUnitedProtect( Vector list ){

        //保护类型
        String lp = SanBootView.res.getString("SelectProtectedSysVolPane.combox.lp");
        String pp = SanBootView.res.getString("SelectProtectedSysVolPane.combox.pp");
        String up = SanBootView.res.getString("SelectProtectedSysVolPane.combox.up");
        ArrayList ptypeList = new ArrayList();
        ptypeList.add( lp );
        ptypeList.add( pp );
        ptypeList.add( up );

        String sup = SanBootView.res.getString("QuerySyncStateDialog.btn.supCluster");
        String unsup = SanBootView.res.getString("QuerySyncStateDialog.btn.nsupCluster");
        ArrayList clusterlist = new ArrayList();
        clusterlist.add(sup);
        clusterlist.add(unsup);

        ArrayList blkList  = BasicVDisk.getBlkSizeList();
        ArrayList poolList = view.initor.mdb.getNormalPoolWrapList( true );
        ArrayList ucsPoolList = view.initor.mdb.getUcsPoolWrapList( true );

        int num = list.size();
        int colNum = 16;
        Object[][] data = new Object[num][colNum];

        header = new Object[colNum];
        label = new Object[num];

        header[0] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.protected");
        header[1] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.vol");
        header[2] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.state");
        header[3] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.ptype"); 
        header[4] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.blksize");
        header[5] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.pool");
        header[6] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.maxSnap");
        header[7] = SanBootView.res.getString("SetUcsPane.label.LatestPool");
        header[8] = SanBootView.res.getString("SetUcsPane.label.OldestPool");
        header[9] = SanBootView.res.getString("SetUcsPane.label.LogPool");
        header[10] = SanBootView.res.getString("SetUcsPane.label.LogNumber");
        header[11] = SanBootView.res.getString("SetUcsPane.label.LogMaxTime");
        header[12] = SanBootView.res.getString("SetUcsPane.label.LogMaxSize");
        header[13] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.formatted");
        header[14] = SanBootView.res.getString("QuerySyncStateDialog.border.cluster");
        header[15] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.desc");


        for( int i=0; i<num; i++ ){
            BindOfPartandVol binder = (BindOfPartandVol)list.elementAt(i);
            data[i][0] = new Boolean( binder.isProtected );
            data[i][1] = binder.part;
            if( binder.isRealVol ){
                data[i][2] = (VolumeWrapper2)binder.vol;
            }else{
                data[i][2] = SanBootView.res.getString("common.nprotected");
            }

            data[i][3] = ( binder.ptype == BootHost.PROTECT_TYPE_CMDP )?(binder.isucsprotected?up:pp):lp;

            if( binder.isRealVol ){
                data[i][4] = BasicVDisk.getBlkSizeStr( binder.vol.getSnap_block_size() );
            }else{
                data[i][4] = BasicVDisk.BLK_SIZE_128K;
            }

            if( binder.isRealVol ){
                PoolWrapper wrap = view.initor.mdb.getPoolWrapper( binder.vol.getSnap_pool_id() );
                if( wrap != null ){
                    data[i][5] = wrap;
                }else{
                    data[i][5] ="";
                }
            }else{
                if( poolList.size() >0 ){
                    data[i][5] = poolList.get(0);
                    
                }else{
                    data[i][5]="";
                    
                }
            }

            data[i][6] = binder.getMaxSnap();
            if( binder.ucsLatestPoolid != -1 ){
                PoolWrapper wrap = view.initor.mdb.getPoolWrapper(binder.ucsLatestPoolid);
                if( wrap != null ){
                    data[i][7] = wrap;
                }
            } else {
                data[i][7] = "";
            }
            if( binder.ucsOldestPoolid != -1 ){
                PoolWrapper wrap = view.initor.mdb.getPoolWrapper(binder.ucsOldestPoolid);
                if( wrap != null ){
                    data[i][8] = wrap;
                }
            } else {
                data[i][8] = "";
            }
            if( binder.ucsLogPoolid != -1 ){
                PoolWrapper wrap = view.initor.mdb.getPoolWrapper(binder.ucsLogPoolid);
                if( wrap != null ){
                    data[i][9] = wrap;
                }
            } else {
                data[i][9] = "";
            }
            if( binder.isRealVol ){
                if( binder.isucsprotected ){
                    data[i][10] = binder.ucsLogNumber;
                } else {
                    data[i][10] = "";
                }
            } else {
                data[i][10] = "10";
            }
            if( "-1".equals(binder.ucsLogMaxTime) ){
                data[i][11] = "";
            } else {
                data[i][11] = binder.ucsLogMaxTime;
            }
            if( "-1".equals(binder.ucsLogMaxSize) ){
                data[i][12] = "";
            } else {
                data[i][12] = binder.ucsLogMaxSize;
            }
            
            
            data[i][13] =  new Boolean( binder.isFormatted );
            data[i][14] =  this.isUUIDCluster?sup:unsup;
            data[i][15] = binder.desc;

            label[i]= binder.part.getDiskLabel();
        }

        MyDefaultTableModelForTabX2 model = new MyDefaultTableModelForTabX2( data,header,label );

        table = new JTableX2( model,view,wizardDiag );
        table.setRowHeight( 20 );
        table.setAutoResizeMode( JTable.AUTO_RESIZE_OFF );

        RowEditorModel rm = new RowEditorModel();
        ((JTableX2)table).setRowEditorModel(rm);

        CheckBoxEditor cb = new CheckBoxEditor();
        rm.addEditorForRow( 0, cb );
        
        MyComboBoxEditor mcb = new MyComboBoxEditor( ptypeList );
        rm.addEditorForRow( 3, mcb );

        MyComboBoxEditor mcb1 = new MyComboBoxEditor( blkList );
        rm.addEditorForRow( 4, mcb1 );

        mcb = new MyComboBoxEditor( poolList );
        rm.addEditorForRow( 5, mcb );

        mcb = new MyComboBoxEditor( ucsPoolList );
        rm.addEditorForRow( 7 , mcb);
        rm.addEditorForRow( 8 , mcb);
        rm.addEditorForRow( 9 , mcb);

        cb = new CheckBoxEditor();
        rm.addEditorForRow( 13, cb );

        rm.addEditorForRow( 14, new MyComboBoxEditor( clusterlist ) );

        TableColumnModel tableColumnModel = table.getColumnModel();
        colNum = tableColumnModel.getColumnCount();
        tableColumnModel.getColumn(0).setWidth( 45 );
        tableColumnModel.getColumn(1).setWidth( 60 );
        tableColumnModel.getColumn(2).setWidth( 70 );
        tableColumnModel.getColumn(3).setWidth( 70 );
        tableColumnModel.getColumn(4).setWidth( 80 );
        tableColumnModel.getColumn(5).setWidth( 175 );
        tableColumnModel.getColumn(6).setWidth( 75 );
        tableColumnModel.getColumn(7).setWidth(75);
        tableColumnModel.getColumn(8).setWidth(75);
        tableColumnModel.getColumn(9).setWidth(75);
        tableColumnModel.getColumn(10).setWidth(75);
        tableColumnModel.getColumn(11).setWidth(75);
        tableColumnModel.getColumn(12).setWidth(75);
        tableColumnModel.getColumn(13).setWidth( 60 );
        tableColumnModel.getColumn(14).setWidth( 80 );
        tableColumnModel.getColumn(15).setWidth( 150 );
        
        for( int j=0;j<colNum;j++ )
            table.sizeColumnsToFit( j );

        table.getTableHeader().setBorder( BorderFactory.createRaisedBevelBorder() );
        table.getTableHeader().setReorderingAllowed(false);

        jScrollPane2.getViewport().add( table,null );
        jScrollPane2.getViewport().setBackground( Color.white );
    }

    public void setupTableForMTPP( Vector list ){
        int i;
        long cap;
        Object[][] data;
        
        ArrayList blkList  = BasicVDisk.getBlkSizeList();
        ArrayList poolList = view.initor.mdb.getPoolWrapList( true );
        
        int num = list.size();
        data = new Object[num][11]; 
        
        header = new Object[11];
        label = new Object[num];

        header[0] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.protected");
        header[1] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.fs");
        header[2] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.property");
        header[3] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.action");
        header[4] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.name");
        header[5] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.size");
        header[6] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.blksize");
        header[7] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.pool");
        header[8] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.maxSnap");
        header[9] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.formatted");
        header[10] = SanBootView.res.getString("SelectProtectedSysVolPane.table.vol.desc");
        
        for( i=0; i<num; i++ ){
            BindOfPartandVol binder = (BindOfPartandVol)list.elementAt(i);
            data[i][0] = new Boolean( binder.isProtected );
            data[i][1] = binder.part;
            data[i][2] = binder.part.vender;
            data[i][3] = ( binder.action == 0 )?Boolean.TRUE:Boolean.FALSE;
            if( binder.isRealVol ){
                data[i][4] = binder.vol;
            }else{
                if( this.hasEnoughSpace ){
                    data[i][4] = binder.volName;
                }else{
                    data[i][4] = null;
                }
            }
            
            // 当存在对应的volmap时，就显示volmap的大小；否则显示实际分区的大小
            if( binder.volSize.equals("") ){
                cap = binder.part.getSizeInGiga();
                data[i][5] = (cap == -1L)? "" : cap+"";
            }else{
                data[i][5] = binder.volSize;
            }
            
            if( binder.isRealVol ){
//System.out.println(" blk size: "+binder.vol.getSnap_block_size() );                
                data[i][6] = BasicVDisk.getBlkSizeStr( binder.vol.getSnap_block_size() );
            }else{
                data[i][6] = BasicVDisk.BLK_SIZE_128K;
            }
            
            if( binder.isRealVol ){           
                PoolWrapper wrap = view.initor.mdb.getPoolWrapper( binder.vol.getSnap_pool_id() );
                if( wrap != null ){
                    data[i][7] = wrap;
                }else{
                    data[i][7] ="";
                }
            }else{
                if( poolList.size() >0 ){
                    data[i][7] = poolList.get(0);
                }else{
                    data[i][7]="";
                }
            }
            
            data[i][8] = binder.getMaxSnap();
            data[i][9] = new Boolean( binder.isFormatted );
            data[i][10] = binder.desc;
                    
            label[i]= binder.part.getDiskLabel();
        }
        
        MyDefaultTableModelForTabX model = new MyDefaultTableModelForTabX( data,header,label );  
        
        table = new JTableX( model,view,wizardDiag,this.hasEnoughSpace );
        table.setRowHeight( 20 );
        table.setAutoResizeMode(JTable.AUTO_RESIZE_OFF);
        
        RowEditorModel rm = new RowEditorModel();
        ((JTableX)table).setRowEditorModel(rm);

        PaneEditor pe = new PaneEditor( (JTableX)table, view, wizardDiag,this.hasEnoughSpace  );
        rm.addEditorForRow( 3, pe );
        
        CheckBoxEditor cb = new CheckBoxEditor();
        rm.addEditorForRow( 0, cb );
        
        MyComboBoxEditor mcb = new MyComboBoxEditor( blkList );
        rm.addEditorForRow( 6, mcb );
        
        mcb = new MyComboBoxEditor( poolList );
        rm.addEditorForRow( 7, mcb );
        
        cb = new CheckBoxEditor();
        rm.addEditorForRow( 9, cb );
        
        TableColumnModel tableColumnModel = table.getColumnModel();
        int colNum = tableColumnModel.getColumnCount();
        tableColumnModel.getColumn(0).setWidth( 45 );
        tableColumnModel.getColumn(1).setWidth( 60 );
        tableColumnModel.getColumn(2).setWidth( 60 );
        tableColumnModel.getColumn(3).setWidth( 120 );
        tableColumnModel.getColumn(4).setWidth( 50 );
        tableColumnModel.getColumn(5).setWidth( 80 );
        tableColumnModel.getColumn(6).setWidth( 70 );
        tableColumnModel.getColumn(7).setWidth( 175 );
        tableColumnModel.getColumn(8).setWidth( 65 );
        tableColumnModel.getColumn(9).setWidth( 50 );
        tableColumnModel.getColumn(10).setWidth( 150 );
        for( i=0;i<colNum;i++ )
            table.sizeColumnsToFit(i);

        table.getTableHeader().setBorder( BorderFactory.createRaisedBevelBorder() );
        table.getTableHeader().setReorderingAllowed(false);
        
        jScrollPane2.getViewport().add( table,null );
        jScrollPane2.getViewport().setBackground( Color.white );
    }
    
    public void setWizardDialogSample( WizardDialogSample wdiag ){
        wizardDiag = wdiag;
    }
    
    public boolean hasProtectOSDiskForCluster(){
        boolean ret = true;
        SystemPartitionForWin part;
        
        DefaultTableModel model =  (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            part = (SystemPartitionForWin)model.getValueAt( row,1);
            if( part.getDiskLabel().equals("C:\\") || part.getDiskLabel().equals("C") ){
                ret = ret & ((Boolean)model.getValueAt(row, 0 )).booleanValue();
            }
        }
        
        return ret;
    }

    public boolean hasProtectOSDisk(){
        SystemPartitionForWin part;

        DefaultTableModel model =  (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            part = (SystemPartitionForWin)model.getValueAt( row,1);
            if( part.getDiskLabel().equals("C:\\") || part.getDiskLabel().equals("C") ){
                return ((Boolean)model.getValueAt(row, 0 )).booleanValue();
            }
        }
        
        return false;
    }
    
    public boolean isFormated( int row ){
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        Boolean isFormat = (Boolean)model.getValueAt(row, 9);
        return isFormat.booleanValue();
    }
    
    public int getSelectOSDiskVolRowOnTable(){
        SystemPartitionForWin part;
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            part = (SystemPartitionForWin)model.getValueAt( row,1);
            if( part.getDiskLabel().equals("C:\\") || part.getDiskLabel().equals("C") ){
                return row;
            }
        }
        
        return -1;
    }

    public Volume getSelectOSDiskVol(){
        if( mode == ResourceCenter.CMD_TYPE_MTPP ){
            return this.getSelectOSDiskVolForMTPP();
        }else{
            return this.getSelectOSDiskVolForCMDP();
        }
    }

    // 只有操作系统盘为真正的iscsi卷时才会返回非null的值
    public Volume getSelectOSDiskVolForMTPP(){
        SystemPartitionForWin part;
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            part = (SystemPartitionForWin)model.getValueAt( row,1);
            if( part.getDiskLabel().equals("C:\\") || part.getDiskLabel().equals("C") ){
                Object val = model.getValueAt( row, 4 );
                if( val instanceof Volume ){
                    return (Volume)val;
                }
            }
        }
        
        return null;
    }

    // 只有操作系统盘为真正的iscsi卷时才会返回非null的值
    public Volume getSelectOSDiskVolForCMDP(){
        SystemPartitionForWin part;

        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            part = (SystemPartitionForWin)model.getValueAt( row,1 );
            if( part.getDiskLabel().equals("C:\\") || part.getDiskLabel().equals("C") ){
                Object val = model.getValueAt( row, 2 );
                if( val instanceof Volume ){
                    return (Volume)val;
                }
            }
        }
        
        return null;
    }

    public String getSelectOSMaxSnap(){
        SystemPartitionForWin part;
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            part = (SystemPartitionForWin)model.getValueAt( row,1);
            if( part.getDiskLabel().equals("C:\\") || part.getDiskLabel().equals("C") ){
                String maxSnap = (String)model.getValueAt( row, 8 );
                return maxSnap;
            }
        }
        
        return "";
    }
    
    public boolean isOSDiskActive(){
        SystemPartitionForWin part;
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            part = (SystemPartitionForWin)model.getValueAt( row,1);
            if( part.getDiskLabel().equals("C:\\") || part.getDiskLabel().equals("C") ){
                return part.isActivePart();
            }
        }
        
        return false;
    }
    
    public boolean hasProtectedDisk(){
        int cnt = 0;
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            Boolean isSel = (Boolean)model.getValueAt(row, 0 );
            if( isSel.booleanValue() ){
                cnt++;
            }
        }
        
        return ( cnt > 0 );
    }

    public boolean hasSharedDiskToProtect(){
        AccessPath ap;

        DefaultTableModel model =  (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            ap = (AccessPath)model.getValueAt( row,4 );
            if( !ap.isLocal ){
                if( ((Boolean)model.getValueAt(row, 0 )).booleanValue() ){
                    return true;
                }
            }
        }

        return false;
    }

    public boolean hasLocalDiskToProtect(){
        AccessPath ap;
        int cnt = 0;

        DefaultTableModel model =  (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            ap = (AccessPath)model.getValueAt( row,4 );
            if( ap.isLocal && ((Boolean)model.getValueAt(row, 0 )).booleanValue() ){
                cnt += 1;
            }
        }

        return ( cnt >= 2 );
    }

    public boolean checkConflictOnSharedDisk(){
        AccessPath ap;
        SystemPartitionForWin part,part1;
        boolean isSel;
        
        ArrayList<SystemPartitionForWin> sharedDiskList = new ArrayList<SystemPartitionForWin>();
        ArrayList<SystemPartitionForWin> localDiskList = new ArrayList<SystemPartitionForWin>();
        DefaultTableModel model =  (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            isSel = ((Boolean)model.getValueAt( row, 0 )).booleanValue();
            if( !isSel ) continue;
            
            ap = (AccessPath)model.getValueAt( row,4 );
            part = (SystemPartitionForWin)model.getValueAt( row,1);
            if( ap.isLocal ){
                localDiskList.add( part );
            }else{
                sharedDiskList.add( part );
            }
        }
        
        int size1 = sharedDiskList.size();
        int size2 = localDiskList.size();
        for( int i=0; i<size1; i++ ){
            part = sharedDiskList.get( i );
            for( int j=0; j<size2; j++ ){
                part1 = localDiskList.get( j );
                if( part.getDiskLabel().equals( part1.getDiskLabel() ) ){
SanBootView.log.error(this.getClass().getName(),part.toString() +" is conflict(local2Shared) with " + part1.toString() );
                    return false;
                }
            }
        }

        return true;
    }

    public boolean checkConflictOnSharedDisk1(){
        AccessPath ap;
        SystemPartitionForWin part,part1;

        ArrayList<SystemPartitionForWin> p_sharedDiskList = new ArrayList<SystemPartitionForWin>();
        ArrayList<SystemPartitionForWin> not_p_sharedDiskList = new ArrayList<SystemPartitionForWin>();
        DefaultTableModel model =  (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            ap = (AccessPath)model.getValueAt( row,4 );
            part = (SystemPartitionForWin)model.getValueAt( row,1);
            if( ap.isShared() ){
                if( ((Boolean)model.getValueAt(row, 0 )).booleanValue() ){
                    p_sharedDiskList.add( part );
                }else{
                    not_p_sharedDiskList.add( part );
                }
            }
        }

        int size1 = p_sharedDiskList.size();
        int size2 = not_p_sharedDiskList.size();
        for( int i=0; i<size1; i++ ){
            part = p_sharedDiskList.get( i );
            for( int j=0; j<size2; j++ ){
                part1 = not_p_sharedDiskList.get( j );
                if( part.getDiskLabel().equals( part1.getDiskLabel() ) ){
SanBootView.log.error(this.getClass().getName(),part.toString() +" is conflict(share2share) with " + part1.toString() );
                    return false;
                }
            }
        }

        return true;
    }

    public boolean checkConflictOnSharedDisk2(){
        AccessPath ap;
        SystemPartitionForWin part;

        Hashtable<String,String> p_sharedDiskList = new Hashtable<String,String>();
        DefaultTableModel model =  (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            ap = (AccessPath)model.getValueAt( row,4 );
            part = (SystemPartitionForWin)model.getValueAt( row,1);
            if( ap.isShared() ){
                if( ((Boolean)model.getValueAt(row, 0 )).booleanValue() ){
                    String ip = p_sharedDiskList.get( part.getDiskLabel() );
                    if( ip == null ){
                        p_sharedDiskList.put( part.getDiskLabel(),ap.ip );
                    }else{
                        if( !ap.ip.equals( ip ) ){
                            return false;
                        }
                    }
                }
            }
        }
        
        return true;
    }

    public boolean checkVolInfoValidity(){
        if( mode == ResourceCenter.CMD_TYPE_MTPP ){
            return this.checkVolInfoValidityForMTPP( );
        }else{
            return this.checkVolInfoValidityForUnitedProtect();
        }
    }

     public boolean checkVolInfoValidityForUnitedProtect(){
        Long acculateSize;
        PoolWrapper poolWrap;
        String bkSizeStr;
        long blkUnit,blockSize,bkNum;
        long valLong;
        int intPType,maxsnap;
        String ptype;
        Object volObj;
        HashMap map = new HashMap();
        HashMap map1 = new HashMap();
        SystemPartitionForWin part;
        boolean notNeedCheckSize;
        int col;

        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            Boolean isSel = (Boolean)model.getValueAt( row, 0 );
            part = (SystemPartitionForWin)model.getValueAt( row, 1);
            volObj = model.getValueAt( row,2 );

            ptype = (String)model.getValueAt( row, 3 );
            if( ptype.equals( SanBootView.res.getString("SelectProtectedSysVolPane.combox.lp") ) ){
                intPType = BootHost.PROTECT_TYPE_MTPP;
            }else if( ptype.equals( SanBootView.res.getString("SelectProtectedSysVolPane.combox.pp") ) ){
                intPType = BootHost.PROTECT_TYPE_CMDP;
            }else {
               if(part.disklabel.contains("C")){
                    int ret = JOptionPane.showConfirmDialog(
                            view,
                            SanBootView.res.getString("InitBootHostWizardDialog.confirm5"),
                            SanBootView.res.getString("common.confirm"),  //"Confirm",
                            JOptionPane.OK_CANCEL_OPTION
                            );
                    if( ( ret == JOptionPane.CANCEL_OPTION ) || ( ret == JOptionPane.CLOSED_OPTION) ){
                        return false;
                    }
                }
                intPType = 3;
                Object obj7 = model.getValueAt( row, 7 );
                Object obj8 = model.getValueAt( row, 8 );
                Object obj9 = model.getValueAt( row, 9 );
                Object obj10 = model.getValueAt( row, 10 );
                if( obj7 == null || obj8 == null || obj9 == null || obj10 == null ){
                    JOptionPane.showMessageDialog(this, SanBootView.res.getString("SelectProtectedSysVolPane.error.ucswrong")  );
                    return false;
                }
            }

            // 已经创建出来的卷就不要再检查尺寸的合法性了
            notNeedCheckSize = ( volObj instanceof Volume );
            
            if( isSel.booleanValue() ){
                if( !notNeedCheckSize ){
                    if( map1.get( part.getDiskLabel() ) == null ){
                        map1.put( part.getDiskLabel(), part );
                    }else{
                        // 不计算重复出现的disk的大小
                        notNeedCheckSize = true;
                    }
                }

                if( !notNeedCheckSize ){
                    // 检查大小是否合法,依据partition的大小来判断
                    Object size = part.getSizeInBytes();
                    if( size == null ){
                        return false;
                    }else{
                        col = this.isCluster?5:4;
                        try{
                            bkSizeStr = (String)model.getValueAt( row, col );
                            blkUnit = BasicVDisk.getBlkSizeFromStr( bkSizeStr );
                        }catch(Exception ex){
                            blkUnit = 17;
                        }

                        col = this.isCluster?6:5;
                        poolWrap = (PoolWrapper)model.getValueAt( row,col );
                        double val = -1;
                        String _val = (String)size;
                        try{
                            val = Double.parseDouble( _val );
                        }catch(Exception ex){
                            JOptionPane.showMessageDialog(this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidVal") + "["+row+","+col+"]"
                            );
                            return false;
                        }

                        blockSize = (long)( 1<< blkUnit );
                        bkNum =(long)( ( val + blockSize-1 )/blockSize );

                        // change unit from GB to byte
                        valLong = blockSize*bkNum; //  真正的卷大小[bytes]
                        vgSize = poolWrap.pool.getRealFreeSize();

                        if( valLong <= 0 || valLong > vgSize ){
                            JOptionPane.showMessageDialog(this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidVal") + "(" + poolWrap.pool.getRealFreeSizeStr() + ") [" + row +","+ col+ "]"
                            );
                            return false;
                        }

                        if( !(volObj instanceof Volume) ){
                            acculateSize = (Long)map.get( poolWrap.pool );
                            if( acculateSize == null ){
                                map.put( poolWrap.pool, new Long( valLong ) );
                            }else{
                                valLong = acculateSize.longValue() + valLong;
                                map.put( poolWrap.pool, new Long( valLong ) );
                            }
                        }
                    }
                }

                col = this.isCluster?7:6;
                Object snapNum = model.getValueAt( row,col );
                if( snapNum == null ){
                    return false;
                }else{
                    maxsnap = ( intPType == BootHost.PROTECT_TYPE_CMDP ||intPType == 3 ) ? ResourceCenter.MAX_SNAP_CMDP_NUM:ResourceCenter.MAX_SNAP_NUM;
                    int num = 0;
                    String _num =(String)snapNum;
                    try{
                        num = Integer.parseInt( _num );
                    }catch(Exception ex){
                        JOptionPane.showMessageDialog(this,
                            SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidSnapVal") +" " +ResourceCenter.MAX_SNAP_NUM  + " ["+row+","+col+"]"
                        );
                        return false;
                    }

                    if( num <= 0 || num > maxsnap ){
SanBootView.log.info(getClass().getName(), " num: "+ num +" res:maxsnap : "+ maxsnap  +" for [" + row +",6]");
                        JOptionPane.showMessageDialog(this,
                            SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidSnapVal") +" " +ResourceCenter.MAX_SNAP_NUM + " ["+row+","+col+"]"
                        );
                        return false;
                    }
                }




                //col = this.isCluster?15:14;
                col = this.isCluster?16:15;
                Object _volDesc = model.getValueAt( row, col );
                if( _volDesc == null ){
                    return false;
                }else{
                    String volDesc = (String)_volDesc;
                    if( !volDesc.equals("") ){
                        if( Check.checkInput( volDesc ) ){
                            JOptionPane.showMessageDialog( this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidVolDesc") + " [" +row+","+col+"]"
                            );
                            return false;
                        }

                        if( volDesc.equals("VG") || volDesc.equals("TGT") ){
                            JOptionPane.showMessageDialog( this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.reservedKeyWord") + " [" +row+","+col+"]"
                            );
                            return false;
                        }

                        if( volDesc.getBytes().length > 256 ){
                            JOptionPane.showMessageDialog( this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidVolDesc") + " [" +row+","+col+"]"
                            );
                            return false;
                        }
                    }
                }
            }else{ // 用户不再保护该卷，检查其上有无mj,若有,则用户必须保护它
                if( hasMj( row,true, null  ) ){
                    JOptionPane.showMessageDialog(this,
                        SanBootView.res.getString("SelectProtectedSysVolPane.error.hasMj") + " :  " + part.toString()
                    );
                    return false;
                }
            }
        }

        // 检查各个pool上总创建容量是否超过其最大空闲值
        Set set  = map.keySet();
        Iterator iterator = set.iterator();
        while( iterator.hasNext() ){
            Pool pool = (Pool)iterator.next();
            Long accuSize = (Long)map.get( pool );
            if( accuSize.longValue() > pool.getRealFreeSize() ){
                JOptionPane.showMessageDialog(this,
                    SanBootView.res.getString("SelectProtectedSysVolPane.error.beyondVgSize") + " " + pool.getPool_name() + " [ " + BasicVDisk.getCapStr( accuSize.longValue() ) + " > " + pool.getRealFreeSizeStr() + " ]"
                );
                return false;
            }
        }



        return true;
    }

    public boolean checkVolInfoValidityForMTPP(){
        boolean isCrt;
        Long acculateSize;
        PoolWrapper poolWrap;
        String bkSizeStr;
        long blkUnit,blockSize,bkNum;
        long valLong;
        HashMap map = new HashMap();
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            Boolean isSel = (Boolean)model.getValueAt( row, 0 );
            if( isSel.booleanValue() ){
                Object vol = model.getValueAt( row, 4 );
                if( vol == null ){
                    JOptionPane.showMessageDialog(this,
                        SanBootView.res.getString("SelectProtectedSysVolPane.error.noneName") + "["+row+",4]"
                    );
                    return false;
                }else{
                    if( !(vol instanceof Volume ) ){
                        String name = (String)vol;
                        if( name.equals("") ){
                            JOptionPane.showMessageDialog(this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.noneName") + "["+row+",4]"
                            );
                            return false;
                        }
                        
                        if( Check.checkInput( name ) ){
                            JOptionPane.showMessageDialog(this,
                                SanBootView.res.getString("CreateOrphanVol.error.badName")
                            );
                            return false;
                        }
                        
                        if( name.getBytes().length >=255 ){
                            JOptionPane.showMessageDialog(this,
                                SanBootView.res.getString("CreateOrphanVol.error.nametoolong")
                            );
                            return false;
                        }
                        
                         //检查名字是否重复
                        if( hasSameNameOnTable( name, row ) || view.hasSameVolName( name ) ){
                            JOptionPane.showMessageDialog(this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.sameName") + "["+row+",4]"
                            );
                            return false;
                        }
                    }
                }
                
                isCrt = ((Boolean)model.getValueAt(row, 3)).booleanValue();
                if( isCrt ){ // 只有创建的卷才检查大小是否合法
                    Object size = model.getValueAt( row,5 );
                    if( size == null ){
                        return false;
                    }else{
                        try{
                            bkSizeStr = (String)model.getValueAt(row, 6);
                            blkUnit = BasicVDisk.getBlkSizeFromStr( bkSizeStr );                
                        }catch(Exception ex){
                            blkUnit = 17;
                        }
                        
                        poolWrap = (PoolWrapper)model.getValueAt( row,7 );
                        double val = -1;
                        String _val = (String)size;
                        try{
                            val = Double.parseDouble( _val );
                        }catch(Exception ex){
                            JOptionPane.showMessageDialog(this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidVal") + "["+row+",5]"
                            );
                            return false;
                        }
                        
                        blockSize = (long)( 1<< blkUnit );
                        bkNum =(long)( ( val*1024*1024*1024 + blockSize-1 )/blockSize );
                        
                        // change unit from GB to byte
                        valLong = blockSize*bkNum; //  真正的卷大小
                        vgSize = poolWrap.pool.getRealFreeSize();
                        
                        if( valLong <= 0 || valLong > vgSize ){
                            JOptionPane.showMessageDialog(this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidVal") + "(" + poolWrap.pool.getRealFreeSizeStr() + ") [" + row + ",5]"
                            );
                            return false;
                        }
                        
                        acculateSize = (Long)map.get( poolWrap.pool );
                        if( acculateSize == null ){
                            map.put( poolWrap.pool, new Long( valLong ) );
                        }else{
                            valLong = acculateSize.longValue() + valLong;       
                            map.put( poolWrap.pool, new Long( valLong ) );
                        }
                    }
                }
                
                if( hasMj( row,isCrt, vol ) ){
                    JOptionPane.showMessageDialog(this,
                        SanBootView.res.getString("SelectProtectedSysVolPane.error.hasMj1") + " ["+row+",4]"
                    );
                    return false;
                }
                
                Object snapNum = model.getValueAt( row,8 );
                if( snapNum == null ){
                    return false;
                }else{
                    int num = 0;
                    String _num =(String)snapNum;
                    try{
                        num = Integer.parseInt( _num );
                    }catch(Exception ex){
                        JOptionPane.showMessageDialog(this,
                            SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidSnapVal") +" " +ResourceCenter.MAX_SNAP_NUM  + " ["+row+",8]"
                        );
                        return false;
                    }
SanBootView.log.info(getClass().getName()," num: "+ num +" res:maxsnap: "+ ResourceCenter.MAX_SNAP_NUM +" for [ " + row +",8 ]");
                    if( num <= 0 || num > ResourceCenter.MAX_SNAP_NUM ){
                        JOptionPane.showMessageDialog(this,
                            SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidSnapVal") +" " +ResourceCenter.MAX_SNAP_NUM + " ["+row+",8]"
                        );
                        return false;
                    }
                }
                
                Object _volDesc = model.getValueAt( row, 10 );
                if( _volDesc == null ){
                    return false;
                }else{
                    String volDesc = (String)_volDesc;
                    if( !volDesc.equals("") ){
                        if( Check.checkInput( volDesc ) ){
                            JOptionPane.showMessageDialog( this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidVolDesc") + " [" +row+",10]"
                            );
                            return false;
                        }
                        
                        if( volDesc.equals("VG") || volDesc.equals("TGT") ){
                            JOptionPane.showMessageDialog( this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.reservedKeyWord") + " [" +row+",10]"
                            );
                            return false;
                        }
                        
                        if( volDesc.getBytes().length > 256 ){
                            JOptionPane.showMessageDialog( this,
                                SanBootView.res.getString("SelectProtectedSysVolPane.error.invalidVolDesc") + " [" +row+",10]"
                            );
                            return false;
                        }
                    }
                }
            }else{ // 用户不再保护该卷，检查其上有无mj,若有,则用户必须保护它
                if( hasMj( row,true, null  ) ){
                    SystemPartitionForWin part = (SystemPartitionForWin)model.getValueAt(row, 1);
                    JOptionPane.showMessageDialog(this,
                        SanBootView.res.getString("SelectProtectedSysVolPane.error.hasMj") + " :  " + part.toString()
                    );
                    return false;
                }
            }
        }
        
        // 检查各个pool上总创建容量是否超过其最大空闲值
        Set set  = map.keySet();
        Iterator iterator = set.iterator();
        while( iterator.hasNext() ){
            Pool pool = (Pool)iterator.next();
            Long accuSize = (Long)map.get( pool );
            if( accuSize.longValue() > pool.getRealFreeSize() ){
                JOptionPane.showMessageDialog(this,
                    SanBootView.res.getString("SelectProtectedSysVolPane.error.beyondVgSize") + " " + pool.getPool_name() + " [ " + BasicVDisk.getCapStr( accuSize.longValue() ) + " > " + pool.getRealFreeSizeStr() + " ]"
                );
                return false;
            }
        }
        
        return true;
    }
    
    public boolean isLessThanUsedSize(){
        boolean isCrt;
        String bkSizeStr;
        long blkUnit,blockSize,bkNum;
        long valLong;
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            Boolean isSel = (Boolean)model.getValueAt( row, 0 );
            if( isSel.booleanValue() ){                
                SystemPartitionForWin localdisk = (SystemPartitionForWin)model.getValueAt( row, 1 );                
                isCrt = ((Boolean)model.getValueAt(row, 3)).booleanValue();
                if( isCrt ){
                    Object size = model.getValueAt( row,5 );
                    try{
                        bkSizeStr = (String)model.getValueAt( row, 6 );
                        blkUnit = BasicVDisk.getBlkSizeFromStr( bkSizeStr );                
                    }catch( Exception ex ){
                        blkUnit = 17;
                    }
                    
                    double val = -1;
                    String _val = (String)size;
                    try{
                        val = Double.parseDouble( _val );
                    }catch(Exception ex){}

                    blockSize = (long)( 1<< blkUnit );
                    bkNum =(long)( ( val*1024*1024*1024 + blockSize-1 )/blockSize );                        
                    // change unit from GB to byte
                    valLong = blockSize*bkNum; //  真正的卷大小
                    
System.out.println(" assign cap: "+ valLong +" used cap: "+ localdisk.getOccupiedInMega()+" MB" );
                    if( localdisk.getOccupiedInMega() != -1L ){
                        if( valLong <= localdisk.getOccupiedInMega()*1024*1024 ){
                            return false;
                        }
                    }
                }else{
                    Object size1 = model.getValueAt( row,5 );
                    double val1 = -1;                    
                    String _val1 = (String)size1;
                    try{
                        val1 = Double.parseDouble( _val1 );
                    }catch(Exception ex){}   
                    
                    if( localdisk.getOccupiedInMega() != -1L ){
System.out.println(" assign cap: "+ val1*1024*1024*1024 +" used cap: "+ localdisk.getOccupiedInMega()+" MB" );                        
                        if( val1*1024*1024*1024 <= localdisk.getOccupiedInMega()*1024*1024 ){
                            return false;
                        }
                    }
                }
            }
        }
        
        return true;   
    }
    
    private boolean hasMj( int index,boolean isCrt,Object _volOnGUI ){
        BindOfPartandVol binder;
        
        // 检查curVolUsage list中有无卷上有mg/mj
        binder = (BindOfPartandVol)curVolUsage.elementAt( index );
        if( isCrt ){
            if( binder.isRealVol ){ // 该盘当前已经存在对应的保护卷,但是用户要重新为它创建一个卷;需要检查当前保护卷由于mg/mg
                return hasMjOnVol( binder.vol.getSnap_root_id() );
            }else{
                return false;
            }
        }else{
            Volume volOnGUI = (Volume)_volOnGUI;
            if( binder.isRealVol ){ // 该盘当前已经存在对应的保护卷,但是用户要重新为它创建一个卷;需要检查当前保护卷由于mg/mj
                if( binder.vol.getSnap_root_id() != volOnGUI.getSnap_root_id() ){
                    if ( hasMjOnVol( binder.vol.getSnap_root_id() ) ){
                        return true;
                    }else{
                        return hasMjOnVol( volOnGUI.getSnap_root_id() );
                    }
                }else{
                    return false;
                }
            }else{
                // 查看新选择的卷有无mj
                return hasMjOnVol( volOnGUI.getSnap_root_id() );
            }
        }
    }
    
    private boolean hasMjOnVol( int rootid ){
        int mg_id;
        
        MirrorGrp mg = view.initor.mdb.getMGFromVectorOnRootID( rootid );
        if( mg == null ){
SanBootView.log.error( getClass().getName(),"Not found mg related rootid: " + rootid );           
            return false;
        }else{
            mg_id = mg.getMg_id();
        }
        
        ArrayList mjList = view.initor.mdb.getMjListFromVecOnMgID( mg_id );
        return ( mjList.size() > 0 );
    }
    
    public boolean isCopyOS(){
        return jRadioButton1.isSelected();
    }
    public void setCopyOSFlag( boolean val ){
        jRadioButton1.setSelected( val );
    }
    
    public boolean isOnlyModRegister(){
        return jRadioButton2.isSelected();
    }
    public void setOnlyModRegisterFlag( boolean val ){
        jRadioButton2.setSelected( val );
    }
    
    public boolean isDonothing(){
        return jRadioButton3.isSelected();
    }
    public void setDonothingFlag( boolean val ){
        jRadioButton3.setSelected( val );
    }
    
    public void setActionMode( boolean isCopyOS,boolean isOnlyModRegister,boolean isDonothing ){
        if( isCopyOS){
            jRadioButton1.setSelected( true );
        }
        if( isOnlyModRegister ){
            jRadioButton2.setSelected( true );
        }
        if( isDonothing ){
            jRadioButton3.setSelected( true );
        }
    }

    public Vector getVolInfo(){
        if( mode == ResourceCenter.CMD_TYPE_MTPP ){
            return getVolInfoForMTPP();
        }else{
            return getVolInfoForCMDP();
        }
    }
    
    public boolean hasSharedVolumeToProtectByCmdp(){
        boolean isLocalDisk;

        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            String ptype = (String)model.getValueAt( row, 3 );
            if( ptype.equals( SanBootView.res.getString("SelectProtectedSysVolPane.combox.pp") ) ){
                if( this.isCluster ){
                    AccessPath ap = (AccessPath)model.getValueAt( row,4 );
                    isLocalDisk = ap.isLocal;
                }else{
                    isLocalDisk = true;
                }
                if( !isLocalDisk ){
                    return true;
                }
            }
        }
        return false;
    }
    
    public Vector<BindOfPartandVol> getAvaiableHeartbeatDiskForCMDP(){
        Hashtable<String,BindOfPartandVol> hash = new Hashtable<String,BindOfPartandVol>();
        Vector<BindOfPartandVol> ret = new Vector<BindOfPartandVol>();
        Vector<BindOfPartandVol> list = getVolInfoForCMDP();
        int size = list.size();
        for( int i=0; i<size; i++ ){
            BindOfPartandVol binder = (BindOfPartandVol)list.get(i);
            if( !binder.isProtected || ( binder.ap != null && binder.ap.isShared() ) ){
                if( hash.get( binder.part.getDiskLabel() ) == null ){
                    hash.put( binder.part.getDiskLabel(), binder );
                }
            }
        }
        
        Enumeration list1 = hash.elements();
        while( list1.hasMoreElements() ){
            ret.add( (BindOfPartandVol)list1.nextElement() );
        }
        return ret;
    }
    
     public Vector<BindOfPartandVol> getVolInfoForCMDP(){
        String aLabel;
        BindOfPartandVol binder,tmpbinder;
        boolean isLocalDisk;
        Hashtable<String,BindOfPartandVol> hash = new Hashtable<String,BindOfPartandVol>();

        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        Vector ret = new Vector( lineNum );

        for( int row=0; row<lineNum; row++ ){
            if( this.isCluster ){
                AccessPath ap = (AccessPath)model.getValueAt( row,4 );
                isLocalDisk = ap.isLocal;
            }else{
                isLocalDisk = true;
            }
            
            if( isLocalDisk ){
                binder = new BindOfPartandVol();
                binder.isProtected = ((Boolean)model.getValueAt( row, 0 )).booleanValue();
                binder.part = (SystemPartitionForWin)model.getValueAt(row, 1);

                Object volObj = model.getValueAt( row,2 );
                if( volObj instanceof Volume ){
                    binder.action = 1;
                    binder.isRealVol = true;
                    binder.vol = (Volume)volObj;
                }else{
                    binder.action = 0;
                    binder.isRealVol = false;
                    binder.volName = (String)volObj;
                }

                try{
                    String ptype = (String)model.getValueAt( row, 3 );
                    if( ptype.equals( SanBootView.res.getString("SelectProtectedSysVolPane.combox.lp") ) ){
                        binder.ptype = BootHost.PROTECT_TYPE_MTPP;
                    }else if( ptype.equals( SanBootView.res.getString("SelectProtectedSysVolPane.combox.pp") ) ){
                        binder.ptype = BootHost.PROTECT_TYPE_CMDP;
                    }else {
                        binder.ptype = BootHost.PROTECT_TYPE_CMDP ;
                        binder.isucsprotected = true ;
                        PoolWrapper wrap = (PoolWrapper)model.getValueAt( row, 7 );
                        binder.ucsLatestPoolid = wrap.pool.getPool_id();
                        wrap = (PoolWrapper)model.getValueAt( row, 8 );
                        binder.ucsOldestPoolid = wrap.pool.getPool_id();
                        wrap = (PoolWrapper)model.getValueAt( row, 9 );
                        binder.ucsLogPoolid = wrap.pool.getPool_id();
                        String tmp = (String)model.getValueAt(row, 10);
                        binder.ucsLogNumber = Integer.parseInt(tmp);
                        String timetmp = (String)model.getValueAt(row, 11);
                        if( timetmp != null && !"".equals(timetmp) && !"0".equals(timetmp)){
                            int tmpInt = Integer.parseInt(timetmp)*60;
                            timetmp = String.valueOf(tmpInt);
                            binder.ucsLogMaxTime = timetmp;
                        } else {
                            binder.ucsLogMaxTime = "";
                        }
                        String iotmp = (String)model.getValueAt(row, 12);
                        if( iotmp != null ){
                            binder.ucsLogMaxSize = iotmp ;
                        } else {
                            binder.ucsLogMaxSize = "";
                        }
                        
                    }
                }catch(Exception ex){
                    binder.ptype = BootHost.PROTECT_TYPE_CMDP;
                }

                if( this.isCluster ){
                    AccessPath ap = (AccessPath)model.getValueAt( row,4 );
                    binder.ap = ap;
                }

                int col = this.isCluster?5:4;
                try{
                    String bkSizeStr = (String)model.getValueAt( row, col );
                    binder.blkSize = BasicVDisk.getBlkSizeFromStr( bkSizeStr );
                }catch(Exception ex){
                    binder.blkSize = 17;
                }

                col = this.isCluster?6:5;
                try{
                    PoolWrapper wrap = (PoolWrapper)model.getValueAt( row, col );
                    binder.poolid = wrap.pool.getPool_id();
                }catch(Exception ex){}

                col = this.isCluster?7:6;
                binder.maxSnap = (String)model.getValueAt( row, col );

                col = this.isCluster?8:13;
                binder.isFormatted = ((Boolean)model.getValueAt( row, col )).booleanValue();
                col = this.isCluster?9:14;
                boolean sup = ((String)model.getValueAt( row, col )).equals( SanBootView.res.getString("QuerySyncStateDialog.btn.supCluster") );
                binder.isclusger = sup;
                col = this.isCluster?10:15;
                binder.desc = (String)model.getValueAt( row, col );

                ret.add( binder );
            }else{ // shared disk
                aLabel = ( (SystemPartitionForWin)model.getValueAt(row, 1) ).getDiskLabel();
                tmpbinder = hash.get( aLabel );
                if( tmpbinder == null ){
                    binder = new BindOfPartandVol();
                    binder.isProtected = ((Boolean)model.getValueAt( row, 0 )).booleanValue();
                    binder.part = (SystemPartitionForWin)model.getValueAt(row, 1);
                    hash.put( binder.part.getDiskLabel(),binder );
                    
                    Object volObj = model.getValueAt( row,2 );
                    if( volObj instanceof Volume ){
                        binder.action = 1;
                        binder.isRealVol = true;
                        binder.vol = (Volume)volObj;
                    }else{
                        binder.action = 0;
                        binder.isRealVol = false;
                        binder.volName = (String)volObj;
                    }

                    try{
                        String ptype = (String)model.getValueAt( row, 3 );
                        if( ptype.equals( SanBootView.res.getString("SelectProtectedSysVolPane.combox.lp") ) ){
                            binder.ptype = BootHost.PROTECT_TYPE_MTPP;
                        }else{
                            binder.ptype = BootHost.PROTECT_TYPE_CMDP;
                        }
                    }catch(Exception ex){
                        binder.ptype = BootHost.PROTECT_TYPE_CMDP;
                    }

                    if( this.isCluster ){
                        AccessPath ap = (AccessPath)model.getValueAt( row,4 );
                        binder.ap = ap;
                    }
                    
                    int col = this.isCluster?5:4;
                    try{
                        String bkSizeStr = (String)model.getValueAt( row, col );
                        binder.blkSize = BasicVDisk.getBlkSizeFromStr( bkSizeStr );
                    }catch(Exception ex){
                        binder.blkSize = 17;
                    }
                    
                    col = this.isCluster?6:5;
                    try{
                        PoolWrapper wrap = (PoolWrapper)model.getValueAt( row, col );
                        binder.poolid = wrap.pool.getPool_id();
                    }catch(Exception ex){}
                    
                    col = this.isCluster?7:6;
                    binder.maxSnap = (String)model.getValueAt( row, col );
                    col = this.isCluster?8:13;
                    binder.isFormatted = ((Boolean)model.getValueAt( row, col )).booleanValue();
                    col = this.isCluster?9:14;
                    binder.desc = (String)model.getValueAt( row, col );
                }else{
                    binder = tmpbinder;
                    
                    if( this.isCluster ){
                        AccessPath ap = (AccessPath)model.getValueAt( row,4 );
                        binder.ap.addOtherPath( ap.ip );
                    }
                }
            }
        }
        
        Enumeration list = hash.elements();
        while( list.hasMoreElements() ){
            ret.add( list.nextElement() );
        }
        return ret;
    }
    
    public ArrayList<SubCluster> generateVolsForSubCluster(){
        BootHost host=null,virtual_host = null;
        BackupClient d2d_clnt;
        VolumeMap volMap;
        Vector<BindOfPartandVol> selVolList;
        
        if( mode == ResourceCenter.CMD_TYPE_MTPP ){
            selVolList = this.getVolInfoForMTPP();
        }else{
            selVolList = this.getVolInfoForCMDP();
        }
        
        Hashtable<String,SubCluster> hash = new Hashtable<String,SubCluster>();
        int size = selVolList.size();
        for( int i=0; i<size; i++ ){
            BindOfPartandVol binder = selVolList.get(i);
            if( binder.isRealVol ){ // 该卷之前被保护过了
                volMap = view.initor.mdb.getVolMapOnRootID( binder.vol.getSnap_root_id() );
                host = view.initor.mdb.getHostFromVectorOnID( volMap.getVolClntID() );
                host.setIP( binder.ap.ip );
                host.setClusterBit();
                d2d_clnt = view.initor.mdb.getClientFromVector( host.getClnt_d2d_cid() );
                if( d2d_clnt != null ) d2d_clnt.setIP( binder.ap.ip );
            }else{ // 该卷没有被保护过
                if( binder.ap.isLocal ){
                    host = view.initor.mdb.getHostFromCacheOnUUID( binder.part.getHost_uuid() );
                    if( host == null ){
                        host = new BootHost();
                        host.setUUID( binder.part.getHost_uuid() );
                    }
                    host.setIP( binder.ap.ip );
                    host.setClusterBit();
                    
                    d2d_clnt = view.initor.mdb.getBkClntOnUUID( binder.part.getHost_uuid() );
                    if( d2d_clnt == null ){
                        d2d_clnt = new BackupClient();
                        d2d_clnt.setIP( binder.ap.ip );
                        d2d_clnt.setUUID( binder.part.getHost_uuid() );
                    }else{
                        d2d_clnt.setIP( binder.ap.ip );
                        host.setClnt_d2d_cid( (int)d2d_clnt.getID() );
                    }
                }else{ // shared disk
                    if( this.cluster_type == ResourceCenter.TYPE_CLUS_RAC_INT ){
                        if( virtual_host == null ){
                            // 理论上oracle rac集群的虚拟主机只需要一个
                            virtual_host = view.initor.mdb.getBootHostOnUUIDAndIPForRac( "", binder.ap.ip );
                        }
                        host = virtual_host;
                    }else{ // not-oracle-rac cluster
                        host = view.initor.mdb.getBootHostOnUUIDAndIP( "",binder.ap.ip );
                    }
                    if( host == null ){
                        host = new BootHost();
                        host.setUUID( "" );
                        host.setIP( binder.ap.ip );
                        virtual_host = host;
                    }
                    host.setClusterBit();
                    
                    d2d_clnt = view.initor.mdb.getBkClntOnUUIDAndIP( "",binder.ap.ip );
                    if( d2d_clnt == null ){
                        d2d_clnt = new BackupClient();
                        d2d_clnt.setIP( binder.ap.ip );
                        d2d_clnt.setUUID( "" );
                    }else{
                        host.setClnt_d2d_cid( (int)d2d_clnt.getID() );
                    }
                }
            }
            
            SubCluster subc  = hash.get( binder.ap.getCombinedIP() );
            if( subc == null ){
                subc = new SubCluster();
                subc.setHost( host );
                subc.setD2d_host( d2d_clnt );
                subc.addDisk( new ClusterVolume( binder ) );
                hash.put( binder.ap.getCombinedIP(), subc );
            }else{
                subc.addDisk( new ClusterVolume( binder ) );
            }
        }
        
        Enumeration list =  hash.elements();
        ArrayList<SubCluster> ret = new ArrayList<SubCluster>();
        while( list.hasMoreElements() ){
            ret.add( (SubCluster)list.nextElement() );
        }
        return ret;
    }
    
    public Vector<BindOfPartandVol> getVolInfoForMTPP(){
        BindOfPartandVol binder;
        boolean isCrt;
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        Vector<BindOfPartandVol> ret = new Vector<BindOfPartandVol>( lineNum );
        
        for( int row=0; row<lineNum; row++ ){
            binder = new BindOfPartandVol();
            binder.isProtected = ((Boolean)model.getValueAt( row, 0 )).booleanValue();
            binder.part = (SystemPartitionForWin)model.getValueAt(row, 1);
            isCrt = ((Boolean)model.getValueAt(row, 3)).booleanValue();
//System.out.println(" action: "+ isCrt );
            binder.action = isCrt? 0 : 1;
            
            Object volObj = model.getValueAt( row,4 );
            if( volObj instanceof Volume ){
                binder.isRealVol = true;
                binder.vol = (Volume)volObj;
            }else{
                binder.isRealVol = false;
                binder.volName = (String)volObj;
            }
            
            binder.volSize = (String)model.getValueAt( row,5 );
            
            try{
                String bkSizeStr = (String)model.getValueAt(row, 6);
                binder.blkSize = BasicVDisk.getBlkSizeFromStr( bkSizeStr );                
            }catch(Exception ex){
                binder.blkSize = 17;
            }
            
            try{
                PoolWrapper wrap = (PoolWrapper)model.getValueAt(row, 7);
                binder.poolid = wrap.pool.getPool_id();
            }catch(Exception ex){}
            
            binder.maxSnap = (String)model.getValueAt( row, 8 );
            binder.isFormatted = ((Boolean)model.getValueAt( row, 9 )).booleanValue();
            binder.desc = (String)model.getValueAt( row, 10);
            
            ret.addElement( binder );
        }
        
        return ret;
    }
    
    public boolean isThisFsProtected( String mp ){
        SystemPartitionForWin part;
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();        
        for( int row=0; row<lineNum; row++ ){
            part = (SystemPartitionForWin)model.getValueAt( row,1 );
            if( part.getDiskLabel().toUpperCase().equals( mp.toUpperCase() ) ){
                return ((Boolean)model.getValueAt(row, 0)).booleanValue();
            }
        }
        
        return false;
    }
    
    private boolean hasSameNameOnTable( String name,int selRow ){
        boolean isSel;
        Volume vol;
        String volName;
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();        
        for( int row=0; row<lineNum; row++ ){
            isSel = ((Boolean)model.getValueAt( row, 0 )).booleanValue();
            if( isSel && row !=selRow ){
                if( mode == ResourceCenter.CMD_TYPE_MTPP ){
                    Object volObj = model.getValueAt( row,4 );
                    if( volObj instanceof Volume ){
                        vol = (Volume)volObj;
                        if( vol.getSnap_name().equals( name ) ){
                            return true;
                        }
                    }else{
                        volName = (String)volObj;
                        if( volName.equals( name ) ){
                            return true;
                        }
                    }
                }else{
                    Object volObj = model.getValueAt( row,2 );
                    if( volObj instanceof Volume ){
                        volName = ((Volume)volObj).toString();
                    }else{
                        volName = (String)volObj;
                    }
                    if( volName.equals( name ) ){
                        return true;
                    }
                }
            }
        }
        return false;
    }

    public void fireEditingStopMsg(){
        if( mode == ResourceCenter.CMD_TYPE_MTPP ){
            this.fireEditingStopMsgForMTPP();
        }else{
            this.fireEditingStopMsgForCMDP();
        }
    }

    public void fireEditingStopMsgForMTPP(){
        TableCellEditor dce;
        
        AbstractTableModel model = (AbstractTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int i=0; i<lineNum; i++  ){
            for( int j=0;j<11;j++ ){ //专门停止0,3，4,5,6,7,8,9,10列
                if( j == 1 || j == 2 ) continue;
                
                dce = table.getCellEditor( i,j );
                if( dce!=null ){
                    try{
                        while(!dce.stopCellEditing()){}
                    }catch(Exception ex){}
                }
            }
        }
    }

        public void fireEditingStopMsgForCMDP(){
        TableCellEditor dce;

        int colNum = this.isCluster?15:8;
        AbstractTableModel model = (AbstractTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int i=0; i<lineNum; i++  ){
            for( int j=0;j<colNum;j++ ){ //专门停止0,2,3,4,5,6列
                if( j == 1 || j ==2 ) continue;

                dce = table.getCellEditor( i,j );
                if( dce!=null ){
                    try{
                        while(!dce.stopCellEditing()){}
                    }catch(Exception ex){}
                }
            }
        }
    }
        public boolean hasSystemLicense(){
            boolean ret = false;
            boolean isOk = view.initor.mdb.updateLicenseCount();
            if( isOk ){
                ret = view.initor.mdb.hasSystemLicense();
            }
            return ret;
        }
        
}
