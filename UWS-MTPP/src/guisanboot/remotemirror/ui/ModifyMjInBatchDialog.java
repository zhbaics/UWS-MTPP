/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * ModifyMjInBatchDialog.java
 *
 * Created on 2010-8-27, 16:31:01
 */

package guisanboot.remotemirror.ui;

import guisanboot.data.MirrorJob;
import guisanboot.remotemirror.ui.multiRenderTable.MirrorJobOptionPaneEditor;
import guisanboot.remotemirror.ui.multiRenderTable.MirrorJobRemoteUWSPaneEditor;
import guisanboot.remotemirror.ui.multiRenderTable.MjOption;
import guisanboot.remotemirror.ui.multiRenderTable.MyDefaultTableModelForTableForModifyMj;
import guisanboot.remotemirror.ui.multiRenderTable.TableForModifyMj;
import guisanboot.remotemirror.ui.multiRenderTable.WrapperOfRemoteUWSAndPool;
import guisanboot.res.ResourceCenter;
import guisanboot.ui.InitProgramDialog;
import guisanboot.ui.InputPasswordDiag;
import guisanboot.ui.SanBootView;
import guisanboot.ui.SlowerLaunch;
import guisanboot.ui.multiRenderTable.CheckBoxEditor;
import guisanboot.ui.multiRenderTable.MyComboBoxEditor;
import guisanboot.ui.multiRenderTable.RowEditorModel;
import java.awt.Color;
import java.awt.Point;
import java.util.ArrayList;
import java.util.HashMap;
import javax.swing.BorderFactory;
import javax.swing.JDialog;
import javax.swing.JOptionPane;
import javax.swing.JTable;
import javax.swing.table.AbstractTableModel;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableCellEditor;
import javax.swing.table.TableColumnModel;

/**
 *
 * @author zjj
 */
public class ModifyMjInBatchDialog extends javax.swing.JDialog implements SlowerLaunch,BatchedOpForMjInterface{

    /** Creates new form ModifyMjInBatchDialog */
    public ModifyMjInBatchDialog(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();
    }

    public ModifyMjInBatchDialog( SanBootView view ) {
        this( view,true );
        myInit( view );
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jPanel2 = new javax.swing.JPanel();
        jPanel3 = new javax.swing.JPanel();
        jCheckBox1 = new javax.swing.JCheckBox();
        jLabel1 = new javax.swing.JLabel();
        jCheckBox2 = new javax.swing.JCheckBox();
        jCheckBox3 = new javax.swing.JCheckBox();
        jCheckBox4 = new javax.swing.JCheckBox();
        jCheckBox5 = new javax.swing.JCheckBox();
        jPanel4 = new javax.swing.JPanel();
        jButton1 = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        jPanel1.setLayout(new java.awt.BorderLayout());
        jPanel1.add(jScrollPane1, java.awt.BorderLayout.CENTER);

        getContentPane().add(jPanel1, java.awt.BorderLayout.CENTER);

        jPanel2.setPreferredSize(new java.awt.Dimension(400, 65));
        jPanel2.setLayout(new java.awt.BorderLayout());

        jPanel3.setPreferredSize(new java.awt.Dimension(400, 25));
        jPanel3.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 0, 3));

        jCheckBox1.setText("Select All");
        jCheckBox1.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 5, 1, 1));
        jCheckBox1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                ModifyMjInBatchDialog.this.actionPerformed(evt);
            }
        });
        jPanel3.add(jCheckBox1);

        jLabel1.setText("选项控制 :");
        jLabel1.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 20, 1, 1));
        jPanel3.add(jLabel1);

        jCheckBox2.setText("Encry");
        jCheckBox2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jCheckBox2ActionPerformed(evt);
            }
        });
        jPanel3.add(jCheckBox2);

        jCheckBox3.setText("Compress");
        jCheckBox3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jCheckBox3ActionPerformed(evt);
            }
        });
        jPanel3.add(jCheckBox3);

        jCheckBox4.setText("copy branch");
        jCheckBox4.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jCheckBox4ActionPerformed(evt);
            }
        });
        jPanel3.add(jCheckBox4);

        jCheckBox5.setText("Auto delete view");
        jCheckBox5.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jCheckBox5ActionPerformed(evt);
            }
        });
        jPanel3.add(jCheckBox5);

        jPanel2.add(jPanel3, java.awt.BorderLayout.NORTH);

        jPanel4.setBorder(javax.swing.BorderFactory.createEmptyBorder(5, 1, 1, 1));
        jPanel4.setPreferredSize(new java.awt.Dimension(400, 33));
        jPanel4.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.CENTER, 35, 5));

        jButton1.setText("OK");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        jPanel4.add(jButton1);

        jButton2.setText("Cancel");
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });
        jPanel4.add(jButton2);

        jPanel2.add(jPanel4, java.awt.BorderLayout.CENTER);

        getContentPane().add(jPanel2, java.awt.BorderLayout.SOUTH);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
        // TODO add your handling code here:
        retVal = new Integer(0);
        this.dispose();
    }//GEN-LAST:event_jButton2ActionPerformed

    private void actionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_actionPerformed
        // TODO add your handling code here:
        do_selCheckBox();
    }//GEN-LAST:event_actionPerformed

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        // TODO add your handling code here:
        do_ok();
    }//GEN-LAST:event_jButton1ActionPerformed

    private void jCheckBox2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jCheckBox2ActionPerformed
        // TODO add your handling code here:
        do_selEncryOpt();
    }//GEN-LAST:event_jCheckBox2ActionPerformed

    private void jCheckBox3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jCheckBox3ActionPerformed
        // TODO add your handling code here:
        do_selCompressOpt();
    }//GEN-LAST:event_jCheckBox3ActionPerformed

    private void jCheckBox4ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jCheckBox4ActionPerformed
        // TODO add your handling code here:
        do_selCopyBranch();
    }//GEN-LAST:event_jCheckBox4ActionPerformed

    private void jCheckBox5ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jCheckBox5ActionPerformed
        // TODO add your handling code here:
        do_selAutoDelView();
    }//GEN-LAST:event_jCheckBox5ActionPerformed

    /**
    * @param args the command line arguments
    */
    public static void main(String args[]) {
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                ModifyMjInBatchDialog dialog = new ModifyMjInBatchDialog(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JCheckBox jCheckBox1;
    private javax.swing.JCheckBox jCheckBox2;
    private javax.swing.JCheckBox jCheckBox3;
    private javax.swing.JCheckBox jCheckBox4;
    private javax.swing.JCheckBox jCheckBox5;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JScrollPane jScrollPane1;
    // End of variables declaration//GEN-END:variables

    SanBootView view;
    TableForModifyMj table;

    private String status = "";
    private int cnt = 0;
    private int totalStep = 0;
    private String errormsg = "";
    private Object retVal = null;

    private void myInit( SanBootView view ){
        this.view = view;
        setupTable();

        setDefaultCloseOperation( JDialog.DO_NOTHING_ON_CLOSE );

        jButton1.setEnabled( false );
        jButton2.setEnabled( false );
        setupLanguage();
    }
    
    private void setupLanguage(){
        this.setTitle( SanBootView.res.getString("ModifyMjInBatchDialog.title") );
        this.jButton1.setText( SanBootView.res.getString("common.button.ok"));
        this.jButton2.setText( SanBootView.res.getString("common.button.cancel"));
        this.jCheckBox1.setText( SanBootView.res.getString("common.selectAll") );
        this.jLabel1.setText( SanBootView.res.getString("ModifyMjInBatchDialog.label.crtOpt"));
        this.jCheckBox2.setText( SanBootView.res.getString("EditMirrorJobDialog.checkbox.des") );
        this.jCheckBox3.setText( SanBootView.res.getString("EditMirrorJobDialog.checkbox.compress") );
        this.jCheckBox4.setText( SanBootView.res.getString("EditMirrorJobDialog.checkbox.copybranch") );
        this.jCheckBox5.setText( SanBootView.res.getString("EditMirrorJobDialog.checkbox.delview") );
    }

    private void do_selCheckBox(){
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            model.setValueAt( new Boolean( this.jCheckBox1.isSelected() ), row, 0 );
        }
        fireEditingStopMsg();
    }

    private void do_selEncryOpt(){
        boolean isSel = this.jCheckBox2.isSelected();

        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            MjOption mjOpt = (MjOption)model.getValueAt( row,5 );
            mjOpt.isEncrySeled = isSel;
            model.setValueAt( mjOpt, row, 5 );
        }
        fireEditingStopMsg();
    }

    private void do_selCompressOpt(){
        boolean isSel = this.jCheckBox3.isSelected();

        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            MjOption mjOpt = (MjOption)model.getValueAt( row,5 );
            mjOpt.isCompressedSeled = isSel;
            model.setValueAt( mjOpt, row, 5 );
        }
        fireEditingStopMsg();
    }

    private void do_selCopyBranch(){
        boolean isSel = this.jCheckBox4.isSelected();

        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            MjOption mjOpt = (MjOption)model.getValueAt( row,5 );
            mjOpt.isCopyBranchSeled = isSel;
            model.setValueAt( mjOpt, row, 5 );
        }
        fireEditingStopMsg();
    }

    private void do_selAutoDelView(){
        boolean isSel = this.jCheckBox5.isSelected();

        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            MjOption mjOpt = (MjOption)model.getValueAt( row,5 );
            mjOpt.isDeleteViewSeled = isSel;
            model.setValueAt( mjOpt, row, 5 );
        }
        fireEditingStopMsg();
    }
    
    public void fireEditingStopMsg(){
        TableCellEditor dce;

        AbstractTableModel model = (AbstractTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int i=0; i<lineNum; i++  ){
            for( int j=0; j<7; j++ ){
                if( j == 1 || j == 3 ) continue;
                
                dce = table.getCellEditor( i,j );
                if( dce != null ){
                    try{
                        while( !dce.stopCellEditing() ){}
                    }catch(Exception ex){}
                }
            }
        }
    }
    
    private void setupTable(){
        ArrayList uwsSrvList = view.initor.mdb.getAllUWSrv();
        int colNum = 7;
        Object[][] data = new Object[0][colNum];
        Object[] header = new Object[colNum];

        header[0] = SanBootView.res.getString("common.sel");
        header[1] = SanBootView.res.getString("View.table.mj.id");
        header[2] = SanBootView.res.getString("View.table.mj.name");
        header[3] = SanBootView.res.getString("View.table.mj.type");
        header[4] = SanBootView.res.getString("View.table.mj.swu");
        header[5] = SanBootView.res.getString("View.table.mj.opt");
        header[6] = SanBootView.res.getString("View.table.mj.desc");

        MyDefaultTableModelForTableForModifyMj model = new MyDefaultTableModelForTableForModifyMj( data,header );
        table = new TableForModifyMj( model,uwsSrvList );
        table.setRowHeight( 20 );
        table.setAutoResizeMode( JTable.AUTO_RESIZE_OFF );

        RowEditorModel rm = new RowEditorModel();
        table.setRowEditorModel( rm );

        CheckBoxEditor cb = new CheckBoxEditor();
        rm.addEditorForRow( 0, cb );

        ArrayList mjTypeList = new ArrayList( 3 );
        mjTypeList.add( SanBootView.res.getString("common.mjtype.remote") );
        mjTypeList.add( SanBootView.res.getString("common.mjtype.localtrack") );
        mjTypeList.add( SanBootView.res.getString("common.mjtype.remotetrack") );
        MyComboBoxEditor mcb = new MyComboBoxEditor( mjTypeList );
        rm.addEditorForRow( 3, mcb );

        MirrorJobRemoteUWSPaneEditor remoteUwsEditor = new MirrorJobRemoteUWSPaneEditor( uwsSrvList,view );
        rm.addEditorForRow( 4,remoteUwsEditor );

        MirrorJobOptionPaneEditor mjOptEditor = new MirrorJobOptionPaneEditor();
        rm.addEditorForRow( 5,mjOptEditor );

        TableColumnModel tableColumnModel = table.getColumnModel();
        int colNum1 = tableColumnModel.getColumnCount();
        tableColumnModel.getColumn(0).setWidth( 45 );
        tableColumnModel.getColumn(1).setWidth( 120 );
        tableColumnModel.getColumn(2).setWidth( 150 );
        tableColumnModel.getColumn(3).setWidth( 100 );
        tableColumnModel.getColumn(4).setWidth( 300 );
        tableColumnModel.getColumn(5).setWidth( 385 );
        tableColumnModel.getColumn(6).setWidth( 175 );
        for( int i=0;i<colNum1;i++ )
            table.sizeColumnsToFit(i);

        table.getTableHeader().setBorder( BorderFactory.createRaisedBevelBorder() );
        table.getTableHeader().setReorderingAllowed( false );

        this.jScrollPane1.getViewport().add( this.table,null );
        jScrollPane1.getViewport().setBackground( Color.white );
    }

    private int getMjOption( MjOption mjOpt ){
        int opt = 0;
        if( mjOpt.isContinueTransferSeled){
            opt |= MirrorJob.MJ_OPT_CONTINUE;
        }
        if( mjOpt.isEncrySeled ){
            opt |= MirrorJob.MJ_OPT_ENCRY;
        }
        if( mjOpt.isCompressedSeled ){
            opt |= MirrorJob.MJ_OPT_ZIP;
        }
        if( mjOpt.isCopyBranchSeled ){
            opt |= MirrorJob.MJ_OPT_BRANCH;
        }
        if( mjOpt.isDeleteViewSeled ){
            opt |= MirrorJob.MJ_OPT_DEL_VIEW;
        }
        return opt;
    }

    ArrayList<MirrorJob> mjList = new ArrayList<MirrorJob>();
    private void do_ok(){
        String local_hostName="",remote_hostName;
        boolean hasErr = false;
        HashMap<Integer,String> map = new HashMap<Integer,String>();
        HashMap<String,Integer> pwdMap = new HashMap<String,Integer>();

        this.fireEditingStopMsg();
        
        DefaultTableModel model = (DefaultTableModel)table.getModel();
        int lineNum = model.getRowCount();
        for( int row=0; row<lineNum; row++ ){
            if( !((Boolean)model.getValueAt( row, 0 )).booleanValue() ) continue;

            MirrorJob mj = (MirrorJob)model.getValueAt( row,1 );
            String job_name = (String)model.getValueAt( row,2 );
            String job_type = (String)model.getValueAt( row,3 );
            WrapperOfRemoteUWSAndPool wrapper = (WrapperOfRemoteUWSAndPool)model.getValueAt( row,4 );
            MjOption mjOpt = (MjOption)model.getValueAt( row,5 );
            String job_desc = (String)model.getValueAt( row,6 );

            if( mj.isMJStart() ){
                boolean ok = view.initor.mdb.checkMg( mj.getMj_mg_id() );
                if( ok ){
                    // mg is still running.
SanBootView.log.error(this.getClass().getName(),"Mj and mg are all running. Don't modify this mj: " + mj.getMj_job_name() );
                    JOptionPane.showMessageDialog(view,
                        SanBootView.res.getString("MenuAndBtnCenter.error.mjisrunning1") +" : " + mj.getMj_job_name()
                    );
                    hasErr = true;
                    break;
                }else{
SanBootView.log.error(this.getClass().getName(),"Mj is running,but mg already stopped. So we stop mj directly for modifying it." );
                    // mg already stopped. So stop mj directly.
                    ok = view.initor.mdb.stopMj( mj.getMj_id() );
                    if( !ok ){
                        JOptionPane.showMessageDialog(view,
                            SanBootView.res.getString("MenuAndBtnCenter.error.mjisrunning1") +" : " + mj.getMj_job_name()
                        );
                        hasErr = true;
                        break;
                    }
                }
            }

            if( job_name.equals("") ){
                JOptionPane.showMessageDialog(this,
                    SanBootView.res.getString("EditMirrorJobDialog.error.noneName")
                );
                hasErr = true;
                break;
            }

            if( job_name.getBytes().length > 254 ){
                JOptionPane.showMessageDialog(this,
                    SanBootView.res.getString("EditMirrorJobDialog.error.tooLongName") + " : " + job_name
                );
                hasErr = true;
                break;
            }
            
            if( !job_desc.equals("") ){
                if( job_desc.getBytes().length > 254 ){
                    JOptionPane.showMessageDialog(this,
                        SanBootView.res.getString("EditMirrorJobDialog.error.tooLongDesc") +" : " + job_desc
                    );
                    hasErr = true;
                    break;
                }
            }

            int type;
            if( job_type.equals( SanBootView.res.getString("common.mjtype.remote") ) ){
                type = MirrorJob.MJ_TYPE_REMOTE;
            }else if( job_type.equals( SanBootView.res.getString("common.mjtype.localtrack") ) ){
                type = MirrorJob.MJ_TYPE_LOCAL_TRACK_JOB;
            }else{
                type = MirrorJob.MJ_TYPE_REMOTE_TRACK_JOB;
            }
SanBootView.log.debug(this.getClass().getName(), "mirror job type to create: " + type );

            if( wrapper.uwsNode == null ){
                JOptionPane.showMessageDialog(this,
                    SanBootView.res.getString("EditMirrorJobDialog.error.noneSWUSrvNode")
                );
                hasErr = true;
                break;
            }

            if( wrapper.pool == null ){
                JOptionPane.showMessageDialog(this,
                    SanBootView.res.getString("EditMirrorJobDialog.error.nonePool") +" : "+wrapper.uwsNode.getUws_ip()
                );
                hasErr = true;
                break;
            }
            
            if( wrapper.pool.pool.getRealFreeSize() <= 0 ){
                JOptionPane.showMessageDialog(this,
                    SanBootView.res.getString("EditMirrorJobDialog.error.insufficientPool") + " : " +
                    wrapper.uwsNode.getUws_ip()+"/"+wrapper.pool.pool.getPool_name()
                );
                hasErr = true;
                break;
            }

            if( pwdMap.get( wrapper.uwsNode.getUws_id()+wrapper.pool.pool.getPool_id()+"" ) == null ){
                if( !wrapper.pool.pool.getPool_passwd().equals("") ){
                    InputPasswordDiag inputPass = new InputPasswordDiag( view,wrapper.uwsNode,wrapper.pool );
                    int width  = 270+ResourceCenter.GLOBAL_DELTA_WIDTH_SIZE;
                    int height = 155+ResourceCenter.GLOBAL_DELTA_HIGH_SIZE;
                    inputPass.setSize( width,height );
                    inputPass.setLocation( getCenterPoint( width,height ) );
                    inputPass.setVisible( true );

                    String passwd = inputPass.getPasswd();
                    if( passwd == null ) {
                        hasErr = true;
                        break;
                    }else{
                        pwdMap.put( wrapper.uwsNode.getUws_id()+wrapper.pool.pool.getPool_id()+"", new Integer( wrapper.pool.pool.getPool_id() ) ) ;
                    }
                }else{
SanBootView.log.error(getClass().getName(), "there is no password for pool on destinated swu server: " + wrapper.uwsNode.getUws_ip() );
                    JOptionPane.showMessageDialog(this,
                        SanBootView.res.getString("EditMirrorJobDialog.error.nopasswd")+" : " +
                        wrapper.uwsNode.getUws_ip()+"/"+wrapper.pool.pool.getPool_name()
                    );
                    hasErr = true;
                    break;
                }
            }
            
            if( type == MirrorJob.MJ_TYPE_LOCAL_TRACK_JOB ){
                if( local_hostName.equals("") ){
                    view.initor.mdb.targetSrvName = null;
                    local_hostName = view.initor.mdb.getHostName();
                    if( local_hostName.equals("") ){
                        JOptionPane.showMessageDialog(this,
                            SanBootView.res.getString("EditMirrorJobDialog.error.getSWUHostName")
                        );
                        hasErr = true;
                        break;
                    }
                }

                view.initor.mdb.targetSrvName = null;
                remote_hostName = map.get( new Integer( wrapper.uwsNode.getUws_id() ) );
                if( remote_hostName == null ){
                    remote_hostName = view.initor.mdb.getHostName( wrapper.uwsNode.getUws_ip(), wrapper.uwsNode.getUws_port(),
                        wrapper.pool.pool.getPool_id(), wrapper.pool.pool.getPool_passwd()
                    );
                    if( remote_hostName.equals("") ){
                        JOptionPane.showMessageDialog(this,
                            SanBootView.res.getString("EditMirrorJobDialog.error.getSWUHostName")
                        );
                        hasErr = true;
                        break;
                    }else{
                        map.put( new Integer( wrapper.uwsNode.getUws_id()), remote_hostName );
                    }
                }

                if( !local_hostName.equals( remote_hostName ) ){
                    JOptionPane.showMessageDialog(this,
                        SanBootView.res.getString("EditMirrorJobDialog.error.mustLocalSWU")
                    );
                    hasErr = true;
                    break;
                }
            }
            
            MirrorJob newMJ = new MirrorJob(
                mj.getMj_mg_id(),
                job_name,
                wrapper.uwsNode.getUws_ip(),
                wrapper.uwsNode.getUws_port(),
                this.getMjOption( mjOpt ),
                wrapper.pool.pool.getPool_id(),
                wrapper.pool.pool.getPool_passwd(),
                job_desc
            );
            newMJ.setMj_id( mj.getMj_id() );

            mjList.add( newMJ );
        }
        
        if( hasErr ) return;

        // 图形化地显示修改过程
        status = "";
        errormsg = "";
        cnt = 0;
        totalStep = mjList.size();
        if( totalStep <=0 ) {
            JOptionPane.showMessageDialog( this,
                SanBootView.res.getString("ModifyMjInBatchDialog.error.noSel")
            );
            return;
        }
        
        this.dispose();

        InitProgramDialog initDiag = new InitProgramDialog(
            view,
            SanBootView.res.getString("ModifyMjInBatchDialog.title.modMj"),
            SanBootView.res.getString("ModifyMjInBatchDialog.label.tip.modMj")
        );
        Thread initThread = new Thread( new BatchedOpForMj( initDiag,this ) );
        initThread.start();
        int width  = 300+ResourceCenter.GLOBAL_DELTA_WIDTH_SIZE;
        int height = 120+ResourceCenter.GLOBAL_DELTA_HIGH_SIZE;
        initDiag.setSize( width, height );
        initDiag.setLocation( view.getCenterPoint(width,height) );
        initDiag.setVisible( true );

        retVal = new Integer(1);
    }

    public boolean init(){
        boolean isFirst=true,retValue =true,isOk;

        StringBuffer errBuf = new StringBuffer();

        int size = this.mjList.size();
        for( int i=0; i<size; i++ ){
            MirrorJob mj = this.mjList.get( i );
            cnt++;
            status = SanBootView.res.getString("ModifyMjInBatchDialog.loadstatus.modify") + " " + mj.getMj_job_name();
            
            isOk = view.initor.mdb.modMj1( mj );
            if( !isOk ){
                retValue = false;
                if( isFirst ){
                    errBuf.append( mj.getMj_job_name() );
                    isFirst = false;
                }else{
                    errBuf.append(","+mj.getMj_job_name() );
                }
            }
        } // for end
        
        if( !retValue ){
            errormsg = SanBootView.res.getString("ModifyMjInBatchDialog.error.modify") + errBuf.toString();
        }else{
            errormsg = "";
        }

        return retValue;
    }
    
    public String getLoadingStatus(){
        return status;
    }

    public int getLoadingProcessVal(){
        return ( cnt * 100 )/totalStep;
    }

    public String getInitErrMsg(){
        return errormsg;
    }

    public boolean isCrtVG(){
        return false;
    }

    public String getSrvIP(){
        return "";
    }

    public Object getRetVal(){
        return this.retVal;
    }

    public Point getCenterPoint(int width,int height){
        int x = ( getSize().width - width ) / 2 + getX();
        int y = ( getSize().height - height ) / 2 + getY();
        return new Point(x,y);
    }
    
    public void enableButton( boolean val ){
        this.jButton1.setEnabled( val );
        this.jButton2.setEnabled( val );

        if( !val)
            setDefaultCloseOperation( JDialog.DO_NOTHING_ON_CLOSE );
        else
            setDefaultCloseOperation( JDialog.DISPOSE_ON_CLOSE );
    }
    
    public JTable getTable(){
        return this.table;
    }
}